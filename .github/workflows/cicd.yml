# 1 ì›Œí¬í”Œë¡œì˜ ì´ë¦„ ì§€ì •
name: CI-CD (Gradle, JDK17)

# 2 ì›Œí¬í”Œë¡œê°€ ì‹œì‘ë  ì¡°ê±´ ì§€ì •
on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: prod-deploy
  cancel-in-progress: true

env:
  JDK_VERSION: '17'

# ğŸ› ï¸ ë°°í¬ ì‘ì—…ì„ ì •ì˜
jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest # GitHub Actionsê°€ ì‚¬ìš©í•  í™˜ê²½

    steps:
      # 1. SSH ì ‘ì† ë° ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Deploy via SSH and Restart Server
        uses: appleboy/ssh-action@v1.0.1
        with:
          # ê° ì„¤ì •ì€ ë³„ë„ì˜ ì¤„ì— ìœ„ì¹˜í•˜ë©°, with: ë³´ë‹¤ ë‘ ì¹¸ ë” ë“¤ì—¬ì“°ê¸° í•©ë‹ˆë‹¤.
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22 # ê¸°ë³¸ SSH í¬íŠ¸

          # 2. EC2 ì„œë²„ì—ì„œ ì‹¤í–‰í•  ëª…ë ¹ì–´ë“¤
          script: |
            # 1. í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤. (ê²½ë¡œê°€ ë‹¤ë¥´ë‹¤ë©´ AZit-3 ë“±ìœ¼ë¡œ ìˆ˜ì •)
            cd AZit
            
            # 2. main ë¸Œëœì¹˜ì˜ ìµœì‹  ì½”ë“œë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.
            git pull origin main
            
            # 3. (ìë™í™” í•µì‹¬!) GitHub Secretsì—ì„œ í‚¤ë¥¼ ì½ì–´ì™€ .env íŒŒì¼ì„ ë®ì–´ì”ë‹ˆë‹¤.
            #    vi .envë¥¼ ìˆ˜ë™ìœ¼ë¡œ í•  í•„ìš”ê°€ ì—†ì–´ì§‘ë‹ˆë‹¤.
            echo "CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}" > .env
            echo "REPLICATE_TOKEN=${{ secrets.REPLICATE_TOKEN }}" >> .env
            echo "AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}" >> .env
            echo "AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}" >> .env
            
            echo "DB_URL=${{ secrets.DB_URL }}" >> .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            
            # 4. gradlew íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œì„ ì¤ë‹ˆë‹¤.
            chmod +x ./gradlew
            
            # 5. í…ŒìŠ¤íŠ¸ëŠ” ê±´ë„ˆë›°ê³  Spring .jar íŒŒì¼ì„ ë¹Œë“œí•©ë‹ˆë‹¤.
            ./gradlew build -x test
            #dd
            # 6. Docker ì´ë¯¸ì§€ë¥¼ ìƒˆë¡œ ë¹Œë“œí•˜ê³  ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.
            docker compose up --build -d